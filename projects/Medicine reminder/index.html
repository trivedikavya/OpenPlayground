<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="image.png" type="image/x-icon">
  <link rel="icon" href="image.png" type="image/png">
    <title>MediMitra - Premium Health Companion</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
       
    </style>
</head>
<body class="pb-24 sm:pb-8">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4 sm:p-6">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-[10%] -left-[10%] w-[60%] sm:w-[40%] h-[40%] bg-blue-600/20 rounded-full blur-[80px] sm:blur-[120px]"></div>
            <div class="absolute -bottom-[10%] -right-[10%] w-[60%] sm:w-[40%] h-[40%] bg-indigo-600/20 rounded-full blur-[80px] sm:blur-[120px]"></div>
        </div>
        
        <div class="bg-white rounded-[2rem] sm:rounded-[2.5rem] p-6 sm:p-10 max-w-sm w-full shadow-2xl relative z-10 animate-slide">
            <div class="flex flex-col items-center mb-8 sm:mb-10 text-center">
                <div class="w-20 h-20 sm:w-16 sm:h-16 rounded-2xl flex items-center justify-center text-white mb-4 sm:mb-6 ">
                    <img src="image.png" alt="MediMitra Logo" class="w-25 h-25 sm:w-30 sm:h-30">
                </div>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-700 tracking-tight">MediMitra</h1>
                <p id="auth-toggle-text" class="text-slate-500 mt-2 font-medium text-sm sm:text-base">Because Every Dose Matters</p>
            </div>
            
            <div class="space-y-3 sm:space-y-4">
                <div class="relative group">
                    <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="auth-username" placeholder="Username" class="w-full pl-12 pr-4 py-3.5 sm:py-4 rounded-xl sm:rounded-2xl bg-slate-50 border border-slate-100 focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-sm sm:text-base">
                </div>
                <div class="relative group">
                    <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="password" id="auth-password" placeholder="Password" class="w-full pl-12 pr-4 py-3.5 sm:py-4 rounded-xl sm:rounded-2xl bg-slate-50 border border-slate-100 focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-sm sm:text-base">
                </div>
                <button onclick="window.handleAuth()" id="auth-btn" class="w-full btn-primary text-white py-4 sm:py-5 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg shadow-xl disabled:opacity-50 mt-2 active:scale-[0.98] transition-transform">
                    Connecting...
                </button>
                <button onclick="window.toggleAuthMode()" id="auth-switch" class="w-full text-slate-500 text-xs sm:text-sm font-bold hover:text-blue-600 py-2 transition-colors">
                    New user? Create secure account
                </button>
            </div>
            <p id="auth-error" class="text-rose-500 text-xs sm:text-sm mt-4 sm:mt-6 text-center hidden p-3 bg-rose-50 rounded-xl border border-rose-100 font-medium"></p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700">
        <nav class="sticky top-0 z-50 glass-nav px-4 sm:px-6 py-3 sm:py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="w-18 h-18 sm:w-18 sm:h-12  flex items-center justify-center text-white shadow-lg">
                    
                    <img src="logo.png" alt="MediMitra Logo" class="w-18 h-18 sm:w-20 sm:h-20">
                </div>
                <h1 class="text-lg sm:text-xl font-extrabold text-slate-900 tracking-tight">MediMitra</h1>
            </div>
            <div class="flex items-center gap-1 sm:gap-2">
                <button onclick="window.toggleSettings(true)" class="flex items-center gap-1.5 px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg sm:rounded-xl hover:bg-slate-100 transition-colors">
                    <span id="display-name" class="text-xs sm:text-sm font-bold text-slate-700 max-w-[80px] sm:max-w-none truncate"></span>
                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 sm:w-4 h-4 text-slate-400"></i>
                </button>
            </div>
        </nav>

        <main class="container mx-auto px-4 sm:max-w-xl pt-6 sm:pt-8">
            <!-- Hero Dashboard -->
            <div class="bg-slate-900 rounded-[2rem] sm:rounded-[2.5rem] p-6 sm:p-8 mb-6 sm:mb-8 text-white relative overflow-hidden card-shadow">
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6 sm:mb-10">
                        <div class="max-w-[70%]">
                            <p class="text-blue-400 font-bold text-[10px] sm:text-xs uppercase tracking-[0.2em] mb-1">Status Overview</p>
                            <h2 class="text-xl sm:text-3xl font-extrabold mb-1">Everything's on track</h2>
                            <p class="text-slate-400 text-xs sm:text-sm font-medium">Keep it up!</p>
                        </div>
                        <div class="bg-white/10 p-2 sm:p-3 rounded-xl sm:rounded-2xl backdrop-blur-md">
                            <p id="live-clock" class="text-base sm:text-xl font-black font-mono">00:00</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 sm:gap-4">
                        <div class="bg-white/5 border border-white/10 rounded-xl sm:rounded-2xl p-3 sm:p-4">
                            <p class="text-slate-400 text-[8px] sm:text-[10px] uppercase font-bold mb-1 sm:mb-2">Completion</p>
                            <div class="flex items-end gap-1.5 sm:gap-2">
                                <span id="stat-percent" class="text-xl sm:text-2xl font-black">0%</span>
                                <span class="text-[8px] sm:text-[10px] text-blue-400 font-bold mb-1">DONE</span>
                            </div>
                        </div>
                        <div class="bg-white/5 border border-white/10 rounded-xl sm:rounded-2xl p-3 sm:p-4">
                            <p class="text-slate-400 text-[8px] sm:text-[10px] uppercase font-bold mb-1 sm:mb-2">Upcoming</p>
                            <div class="flex items-end gap-1.5 sm:gap-2">
                                <span id="stat-remaining" class="text-xl sm:text-2xl font-black">0</span>
                                <span class="text-[8px] sm:text-[10px] text-orange-400 font-bold mb-1">LEFT</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="absolute -right-10 -bottom-10 w-32 h-32 sm:w-40 sm:h-40 bg-blue-600/30 rounded-full blur-[50px] sm:blur-[60px]"></div>
            </div>

            <div class="flex justify-between items-center mb-6 px-1">
                <h3 class="text-lg sm:text-xl font-extrabold text-slate-900">Your Schedule</h3>
                <button onclick="window.toggleAddModal(true)" class="btn-primary text-white p-2.5 sm:p-3 rounded-xl sm:rounded-2xl flex items-center gap-2 font-bold shadow-lg shadow-blue-200">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="schedule-list" class="space-y-3 sm:space-y-4">
                <!-- Skeletons while loading -->
                <div class="bg-white rounded-2xl sm:rounded-3xl p-5 sm:p-6 border border-slate-100 animate-pulse h-20 sm:h-24"></div>
                <div class="bg-white rounded-2xl sm:rounded-3xl p-5 sm:p-6 border border-slate-100 animate-pulse h-20 sm:h-24"></div>
            </div>
        </main>

        <!-- Persistent Bottom Footer for All Devices -->
        <footer class="fixed bottom-0 inset-x-0 z-50 glass-footer flex flex-col items-center">
            <!-- Navigation Icons -->
            <div class="flex justify-around items-center w-full max-w-xl mx-auto px-6 py-3">
                <button class="flex flex-col items-center gap-1 text-blue-600 transition-colors">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">Home</span>
                </button>
                <button onclick="window.toggleAddModal(true)" class="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500 transition-colors">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">Add</span>
                </button>
                
                <button onclick="window.toggleSettings(true)" class="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500 transition-colors">
                    <i data-lucide="user" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">Profile</span>
                </button>
            </div>
            <!-- Sub-footer Branding -->
            <div class="w-full text-center pb-3 pt-2 border-t border-slate-100/50 bg-slate-50/50">
                <div class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-4 px-4">
                    <p class="text-slate-500 text-[10px] font-bold tracking-tight">MediMitra: Your Health, Our Mission</p>
                    <span class="hidden sm:inline text-slate-300">•</span>
                    <p class="text-slate-600 text-[9px] font-medium uppercase tracking-wider">Made by Sheetal Bajaj</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="add-modal" class="fixed inset-0 z-[150] bg-slate-900/60 backdrop-blur-md hidden items-center justify-center p-4 sm:p-6">
        <div class="bg-white rounded-[2rem] sm:rounded-[2.5rem] p-6 sm:p-10 w-full max-w-md shadow-2xl animate-slide max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 sm:mb-8">
                <h2 class="text-xl sm:text-2xl font-extrabold text-slate-900">Add Medication</h2>
                <button onclick="window.toggleAddModal(false)" class="p-2 text-slate-400 hover:bg-slate-50 rounded-lg sm:rounded-xl">
                    <i data-lucide="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4 sm:space-y-6">
                <div>
                    <label class="text-[10px] sm:text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1.5 sm:mb-2 block">Medication Name</label>
                    <input type="text" id="new-med-name" placeholder="e.g. Aspirin" class="w-full px-4 py-3 sm:px-5 sm:py-4 rounded-xl sm:rounded-2xl bg-slate-50 border border-slate-100 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-sm sm:text-base">
                </div>
                <div class="grid grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="text-[10px] sm:text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1.5 sm:mb-2 block">Dosage</label>
                        <input type="text" id="new-med-dose" placeholder="e.g. 1 pill" class="w-full px-4 py-3 sm:px-5 sm:py-4 rounded-xl sm:rounded-2xl bg-slate-50 border border-slate-100 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-sm sm:text-base">
                    </div>
                    <div>
                        <label class="text-[10px] sm:text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1.5 sm:mb-2 block">Set Time</label>
                        <input type="time" id="new-med-time" class="w-full px-4 py-3 sm:px-5 sm:py-4 rounded-xl sm:rounded-2xl bg-slate-50 border border-slate-100 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-sm sm:text-base">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] sm:text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-2.5 sm:mb-3 block">Color Category</label>
                    <div class="grid grid-cols-6 gap-2 sm:gap-4">
                        <button onclick="window.selectColor('blue')" id="color-blue" class="w-full aspect-square rounded-full bg-blue-500 ring-4 ring-blue-100 border-2 border-white"></button>
                        <button onclick="window.selectColor('orange')" id="color-orange" class="w-full aspect-square rounded-full bg-orange-500 ring-4 ring-transparent border-2 border-white"></button>
                        <button onclick="window.selectColor('green')" id="color-green" class="w-full aspect-square rounded-full bg-green-500 ring-4 ring-transparent border-2 border-white"></button>
                        <button onclick="window.selectColor('indigo')" id="color-indigo" class="w-full aspect-square rounded-full bg-indigo-500 ring-4 ring-transparent border-2 border-white"></button>
                        <button onclick="window.selectColor('rose')" id="color-rose" class="w-full aspect-square rounded-full bg-rose-500 ring-4 ring-transparent border-2 border-white"></button>
                        <button onclick="window.selectColor('amber')" id="color-amber" class="w-full aspect-square rounded-full bg-amber-500 ring-4 ring-transparent border-2 border-white"></button>
                    </div>
                </div>
            </div>
            
            <button onclick="window.saveNewMedicine()" id="save-med-btn" class="w-full btn-primary text-white py-4 sm:py-5 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg mt-8 sm:mt-10 shadow-xl active:scale-[0.98]">
                Add Medication
            </button>
        </div>
    </div>

    <!-- Alarm Modal -->
    <div id="alarm-overlay" class="fixed inset-0 z-[200] bg-blue-600/95 backdrop-blur-2xl hidden flex-col items-center justify-center p-6 sm:p-8 text-center text-white">
        <div class="bg-white rounded-full p-8 sm:p-10 mb-6 sm:mb-8 animate-bounce">
            <i data-lucide="bell" class="w-12 h-12 sm:w-16 sm:h-16 text-blue-600"></i>
        </div>
        <p class="text-blue-200 text-xs sm:text-sm font-bold uppercase tracking-[0.3em] mb-4">Medication Alert</p>
        <h2 class="text-3xl sm:text-5xl font-black mb-2 tracking-tight leading-tight">Time to take it</h2>
        <p id="alarm-med-name" class="text-xl sm:text-3xl font-medium mb-10 sm:mb-12 text-white/80"></p>
        <button onclick="window.acknowledgeAlarm()" class="w-full max-w-xs bg-white text-blue-600 py-5 sm:py-6 rounded-2xl sm:rounded-3xl text-xl sm:text-2xl font-black shadow-2xl active:scale-95 transition-all">
            DONE, THANKS
        </button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[160] bg-slate-900/60 backdrop-blur-md hidden items-center justify-center p-4 sm:p-6">
        <div class="bg-white rounded-[2rem] sm:rounded-[2.5rem] p-6 sm:p-10 w-full max-w-md shadow-2xl animate-slide">
            <h2 class="text-xl sm:text-2xl font-extrabold text-slate-900 mb-6 sm:mb-8">Account Settings</h2>
            <div class="space-y-3 sm:space-y-4">
                <div class="p-3 sm:p-4 bg-slate-50 rounded-xl sm:rounded-2xl flex items-center justify-between border border-slate-100">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="w-9 h-9 sm:w-10 sm:h-10 bg-blue-100 rounded-lg sm:rounded-xl flex items-center justify-center text-blue-600">
                            <i data-lucide="bell" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        </div>
                        <span class="font-bold text-sm sm:text-base text-slate-800">Alert Volume</span>
                    </div>
                    <button onclick="window.testSound()" class="text-[10px] sm:text-xs font-bold bg-white px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 active:bg-slate-100">Test</button>
                </div>
                <button onclick="window.logout()" class="w-full p-3 sm:p-4 bg-rose-50 rounded-xl sm:rounded-2xl flex items-center gap-2 sm:gap-3 text-rose-600 font-bold border border-rose-100 active:bg-rose-100 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    Sign Out
                </button>
            </div>
            <button onclick="window.toggleSettings(false)" class="w-full mt-6 sm:mt-8 py-4 sm:py-5 bg-slate-900 text-white font-bold rounded-xl sm:rounded-2xl active:scale-[0.98]">Close Settings</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION START ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDw3ZozNb_NJgv3l_7vN7XTXIPdMHEAtRM",
            authDomain: "medimitra1-4fac0.firebaseapp.com",
            projectId: "medimitra1-4fac0",
            storageBucket: "medimitra1-4fac0.firebasestorage.app",
            messagingSenderId: "158778950976",
            appId: "1:158778950976:web:5c9108464a747e111026a5",
            measurementId: "G-9B2FCCF52Z"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'medimitra-prod-v2';
        // --- CONFIGURATION END ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let medications = [];
        let selectedColor = 'blue';
        let isSignup = false;
        let activeAlarmId = null;
        let unsubscribeMeds = null;
        let isAuthReady = false;

        const alarmSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
        alarmSound.loop = true;

        window.testSound = () => {
            alarmSound.play().catch(e => console.warn("Interaction needed"));
            setTimeout(() => { alarmSound.pause(); alarmSound.currentTime = 0; }, 2000);
        };

        window.toggleAuthMode = () => {
            isSignup = !isSignup;
            document.getElementById('auth-btn').innerText = isSignup ? 'Secure Create' : 'Enter Mitra';
            document.getElementById('auth-switch').innerText = isSignup ? 'I already have a key' : 'New user? Create secure account';
        };

        window.handleAuth = async () => {
            if (!isAuthReady) return;
            const user = document.getElementById('auth-username').value.trim();
            const pass = document.getElementById('auth-password').value.trim();
            const err = document.getElementById('auth-error');
            const btn = document.getElementById('auth-btn');

            if (!user || !pass) {
                err.innerText = "Identification required";
                err.classList.remove('hidden');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerText = "Authenticating...";
                const cleanUser = user.toLowerCase().replace(/[^a-z0-9]/g, '');
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', cleanUser);
                const userDoc = await getDoc(userRef);

                if (isSignup) {
                    if (userDoc.exists()) {
                        err.innerText = "Username already claimed.";
                        err.classList.remove('hidden');
                    } else {
                        await setDoc(userRef, { password: btoa(pass), createdAt: Date.now(), username: cleanUser });
                        window.proceedLogin(cleanUser);
                    }
                } else {
                    if (userDoc.exists() && userDoc.data().password === btoa(pass)) {
                        window.proceedLogin(cleanUser);
                    } else {
                        err.innerText = "Invalid credentials.";
                        err.classList.remove('hidden');
                    }
                }
            } catch (e) {
                err.innerText = "Connection issue.";
                err.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = isSignup ? 'Secure Create' : 'Enter Mitra';
            }
        };

        window.proceedLogin = (username) => {
            localStorage.setItem('medimitra_user', username);
            setupApp(username);
        };

        window.logout = () => {
            if (unsubscribeMeds) unsubscribeMeds();
            localStorage.removeItem('medimitra_user');
            location.reload();
        };

        function setupApp(username) {
            if (!auth.currentUser) return;
            currentUser = username;
            document.getElementById('display-name').innerText = username;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            setTimeout(() => { document.getElementById('app-content').style.opacity = '1'; }, 10);
            
            if (unsubscribeMeds) unsubscribeMeds();
            const qMeds = collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'meds');
            unsubscribeMeds = onSnapshot(qMeds, (snapshot) => {
                medications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedule();
                updateStats();
            });

            if (!window.clockStarted) {
                window.clockStarted = true;
                setInterval(() => {
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                    document.getElementById('live-clock').innerText = timeStr;
                    checkAlarms(timeStr);
                }, 1000);
            }
        }

        function updateStats() {
            const total = medications.length;
            const taken = medications.filter(m => m.takenToday).length;
            const remaining = total - taken;
            const percent = total === 0 ? 0 : Math.round((taken / total) * 100);
            document.getElementById('stat-percent').innerText = `${percent}%`;
            document.getElementById('stat-remaining').innerText = remaining;
        }

        function checkAlarms(time) {
            const med = medications.find(m => m.time === time && !m.takenToday && activeAlarmId !== m.id);
            if (med) {
                activeAlarmId = med.id;
                document.getElementById('alarm-med-name').innerText = med.name;
                document.getElementById('alarm-overlay').classList.remove('hidden');
                document.getElementById('alarm-overlay').classList.add('flex');
                alarmSound.play().catch(e => console.log("Sound interaction needed"));
            }
        }

        window.acknowledgeAlarm = async () => {
            alarmSound.pause();
            alarmSound.currentTime = 0;
            if (activeAlarmId && auth.currentUser) {
                const medRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'meds', activeAlarmId);
                await updateDoc(medRef, { takenToday: true });
            }
            document.getElementById('alarm-overlay').classList.add('hidden');
            document.getElementById('alarm-overlay').classList.remove('flex');
            activeAlarmId = null;
        };

        window.toggleAddModal = (s) => {
            const el = document.getElementById('add-modal');
            el.classList.toggle('hidden', !s);
            el.classList.toggle('flex', s);
            document.body.classList.toggle('modal-open', s);
        };
        window.toggleSettings = (s) => {
            const el = document.getElementById('settings-modal');
            el.classList.toggle('hidden', !s);
            el.classList.toggle('flex', s);
            document.body.classList.toggle('modal-open', s);
        };

        window.selectColor = (c) => {
            selectedColor = c;
            ['blue', 'orange', 'green', 'indigo', 'rose', 'amber'].forEach(col => {
                const el = document.getElementById('color-'+col);
                if (el) {
                    el.classList.toggle('ring-blue-100', col === c);
                    el.classList.toggle('ring-transparent', col !== c);
                }
            });
        };

        window.saveNewMedicine = async () => {
            const name = document.getElementById('new-med-name').value;
            const dose = document.getElementById('new-med-dose').value;
            const time = document.getElementById('new-med-time').value;
            if (!name || !time || !auth.currentUser) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'meds'), {
                    name, dose, time, color: selectedColor, takenToday: false, addedAt: Date.now()
                });
                window.toggleAddModal(false);
                document.getElementById('new-med-name').value = "";
                document.getElementById('new-med-dose').value = "";
                document.getElementById('new-med-time').value = "";
            } catch (e) { console.error(e); }
        };

        window.deleteMed = async (id) => {
            if (auth.currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'meds', id));
        };

        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            list.innerHTML = medications.length ? "" : `<div class="text-center py-20 animate-slide"><div class="text-slate-200 mb-4"><i data-lucide="calendar-plus" class="w-16 h-16 mx-auto"></i></div><p class="text-slate-400 font-bold">Plan your medications</p></div>`;
            [...medications].sort((a,b) => a.time.localeCompare(b.time)).forEach(med => {
                const div = document.createElement('div');
                div.className = `med-card bg-white rounded-2xl sm:rounded-[2rem] p-4 sm:p-6 flex items-center gap-4 sm:gap-5 border border-slate-100 card-shadow ${med.takenToday ? 'opacity-40 grayscale-[0.5]' : ''}`;
                div.innerHTML = `
                    <div class="tag-${med.color} w-12 h-12 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center shrink-0">
                        <i data-lucide="pill" class="w-6 h-6 sm:w-7 sm:h-7"></i>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <h3 class="font-extrabold text-sm sm:text-base text-slate-900 truncate">${med.name}</h3>
                        <p class="text-[10px] sm:text-xs text-slate-500 font-bold flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> ${med.time} • ${med.dose || 'Dosage'}
                        </p>
                    </div>
                    <div class="flex items-center gap-1 sm:gap-3">
                        <button onclick="window.deleteMed('${med.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        </button>
                        <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center ${med.takenToday ? 'bg-green-500 text-white shadow-lg shadow-green-100' : 'bg-slate-50 border border-slate-100 text-slate-200'}">
                            <i data-lucide="check" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                const btn = document.getElementById('auth-btn');
                if (btn) btn.innerText = "Retry Config";
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAuthReady = true;
                const btn = document.getElementById('auth-btn');
                if (btn) btn.innerText = isSignup ? 'Secure Create' : 'Enter Mitra';
                const savedUser = localStorage.getItem('medimitra_user');
                if (savedUser) setupApp(savedUser);
            }
        });

        lucide.createIcons();

        
    </script>
    <script src="script.js"></script>
</body>
</html>